<!doctype html>
<html lang="zh-Hant">
<head>
  <meta name="robots" content="noindex, nofollow, noarchive">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å®¢æˆ¶ç³»çµ±ç¶­è­·æ¸…å–®</title>
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <style>
    /* é è¨­éš±è—æ•´å€‹ body */
    body { display: none; margin: 0; font-family: sans-serif; background: #f8fafc; }
  /* é˜²æ­¢åœ¨æ…¢é€Ÿç¶²è·¯ä¸‹å‡ºç¾é–ƒçˆ */
    :root {
      --primary: #4361ee; --primary-light: #eef2ff; --success: #10b981;
      --warning: #f59e0b; --danger: #ef4444; --text-main: #1e293b;
      --text-muted: #64748b; --bg-body: #f8fafc; --card-bg: #ffffff;
      --border: #e2e8f0; --radius-lg: 16px; --radius-md: 12px;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }

    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Inter', 'Noto Sans TC', sans-serif; background: var(--bg-body); color: var(--text-main); }
    
    header { background: var(--card-bg); border-bottom: 1px solid var(--border); padding: 0.75rem 1.5rem; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; }
    .logo { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 1.25rem; color: var(--primary); }
    
    .version-badge { font-size: 0.65rem; background: #f1f5f9; color: #94a3b8; padding: 2px 8px; border-radius: 4px; font-weight: 400; margin-left: 8px; display: none; }
    body.mode-admin .version-badge { display: inline-block; }

    .mode-switcher { background: #f1f5f9; padding: 4px; border-radius: 100px; display: flex; gap: 4px; border: 1px solid var(--border); }
    .mode-btn { border: none; padding: 6px 16px; border-radius: 100px; background: transparent; color: var(--text-muted); font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: 0.3s; }
    .mode-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

    main { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.25rem; margin-bottom: 2rem; }
    .stat-card { background: var(--card-bg); padding: 1.25rem; border-radius: var(--radius-lg); box-shadow: var(--shadow); display: flex; align-items: center; gap: 1rem; }

    .controls { display: flex; align-items: center; gap: 10px; margin-bottom: 1.5rem; }
    .search-wrapper { flex: 2; position: relative; display: flex; align-items: center; }
    .search-wrapper input { width: 100%; padding: 10px 10px 10px 40px; border-radius: var(--radius-md); border: 1px solid var(--border); outline: none; height: 42px; }
    .search-wrapper .material-symbols-rounded { position: absolute; left: 12px; color: var(--text-muted); }
    .control-item { flex: 1; height: 42px; border-radius: var(--radius-md); border: 1px solid var(--border); padding: 0 10px; background: white; min-width: 120px; }
    
    .btn { padding: 8px 16px; border-radius: var(--radius-md); border: none; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; font-size: 0.9rem; transition: 0.2s; white-space: nowrap; height: 42px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-main); }
    
    .sales-tag { background: #e0e7ff; color: #4338ca; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
    .eng-tag { background: #f0fdf4; border: 1px solid #86efac; color: #166534; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; display: inline-block; margin-top: 4px; }
    .month-chip { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin: 2px; display: inline-flex; border: 1px solid var(--border); background: #f1f5f9; color: var(--text-muted); }
    .month-chip.is-done { background: #dcfce7; color: #166534; border-color: #86efac; }
    .month-chip.active:not(.is-done) { border: 1px solid var(--danger); background-color: #fff1f2; color: var(--text-muted); }

    /* å‚™è¨»åœ–ç¤ºæ¨£å¼å„ªåŒ– */
    .note-trigger { 
      cursor: pointer; color: var(--primary); margin-left: 8px; display: inline-flex; align-items: center; 
      padding: 4px; border-radius: 50%; transition: 0.2s;
    }
    .note-trigger:hover { background: var(--primary-light); }

    .table-container { background: var(--card-bg); border-radius: var(--radius-lg); box-shadow: var(--shadow); overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 900px; }
    th { background: #f8fafc; padding: 16px; font-size: 0.8rem; color: var(--text-muted); text-align: left; border-bottom: 1px solid var(--border); }
    td { padding: 16px; border-bottom: 1px solid var(--border); vertical-align: middle; }

    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 999; display: none; }
    .drawer { position: fixed; right: -100%; top: 0; width: 100%; max-width: 500px; height: 100%; background: white; z-index: 1000; transition: right 0.3s ease; padding: 2rem; overflow-y: auto; box-shadow: -10px 0 30px rgba(0,0,0,0.1); }
    .drawer.open { right: 0; }
    
    .note-view-content { line-height: 1.6; color: #334155; font-size: 0.95rem; background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid var(--border); }

    .form-group { margin-bottom: 1.25rem; }
    .form-group label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; }
    input, select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); font-size: 0.95rem; }
    #editor-container { height: 250px; border-radius: 0 0 8px 8px; }
    
    .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: white; padding: 2rem; border-radius: var(--radius-lg); z-index: 1100; width: 90%; max-width: 400px; display: none; }
  </style>
</head>
<body class="mode-eng">

  <header>
    <div class="logo"><span class="material-symbols-rounded">analytics</span> å®¢æˆ¶ç³»çµ±ç¶­è­·æ¸…å–® <span class="version-badge">v5.260108</span></div>
    <div class="mode-switcher" id="modeSeg">
      <button class="mode-btn" data-mode="admin">ç®¡ç†è€…</button>
      <button class="mode-btn active" data-mode="eng">å·¥ç¨‹å¸«</button>
    </div>
  </header>

  <main>
    <div class="stats-row">
      <div class="stat-card">
        <div style="background:var(--primary-light); color:var(--primary); padding:10px; border-radius:12px;"><span class="material-symbols-rounded">inventory_2</span></div>
        <div><div style="font-size:0.75rem; color:var(--text-muted);">ç¸½ç¶­è­·æ•¸</div><div style="font-size:1.25rem; font-weight:700;" id="statTotal">0</div></div>
      </div>
      <div class="stat-card">
        <div style="background:#dcfce7; color:var(--success); padding:10px; border-radius:12px;"><span class="material-symbols-rounded">verified</span></div>
        <div><div style="font-size:0.75rem; color:var(--text-muted);">æœ¬æœˆå·²å®Œå·¥</div><div style="font-size:1.25rem; font-weight:700;" id="statDone">0</div></div>
      </div>
      <div class="stat-card">
        <div style="background:#fff1f2; color:var(--danger); padding:10px; border-radius:12px;"><span class="material-symbols-rounded">notification_important</span></div>
        <div><div style="font-size:0.75rem; color:var(--text-muted);">æœ¬æœˆå¾…è™•ç†</div><div style="font-size:1.25rem; font-weight:700;" id="statTodo">0</div></div>
      </div>
    </div>

    <div class="controls">
      <div class="search-wrapper">
        <span class="material-symbols-rounded">search</span>
        <input type="text" id="q" placeholder="å¿«é€Ÿæœå°‹å®¢æˆ¶æˆ–æ¥­å‹™...">
      </div>
      <input type="month" id="monthPick" class="control-item">
      <select id="scope" class="control-item">
        <option value="all">å…¨éƒ¨ç´€éŒ„</option>
        <option value="need">æœ¬æœˆç¶­è­·</option>
      </select>
      <button class="btn btn-primary" id="btnNew" style="display:none;"><span class="material-symbols-rounded">add</span> æ–°å¢ç¶­è­·</button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>å®¢æˆ¶åç¨±</th>
            <th>ç”¢å“ / æ¥­å‹™</th>
            <th>ç¶­è­·æœŸé–“</th> <th>ç¶­è­·é€±æœŸ</th>
            <th>ç‹€æ…‹ / å·¥ç¨‹å¸«</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </main>

  <div class="overlay" id="overlay" onclick="closeAllDrawers()"></div>

  <div class="drawer" id="noteDrawer">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
      <h2 id="noteTitle" style="margin:0">å®¢æˆ¶å‚™è¨»</h2>
      <button class="btn btn-outline" style="padding:4px; height:auto;" onclick="closeAllDrawers()"><span class="material-symbols-rounded">close</span></button>
    </div>
    <div id="noteContent" class="note-view-content"></div>
    <button class="btn btn-primary" style="width:100%; margin-top:1.5rem;" onclick="closeAllDrawers()">é—œé–‰è¦–çª—</button>
  </div>

  <div class="drawer" id="editDrawer">
    <h2 id="drawerTitle">ç¶­è­·ç´€éŒ„ç·¨è¼¯</h2>
    <form id="formEdit">
      <div class="form-group"><label>å®¢æˆ¶åç¨±</label><input type="text" id="customer" required></div>
      <div class="form-group"><label>ç”¢å“é …ç›®</label><select id="product"><option value="ee-class">ee-class</option><option value="Adobe Connect">Adobe Connect</option><option value="km+">km+</option><option value="tms+">tms+</option></select></div>
      <div class="form-group"><label>è² è²¬æ¥­å‹™</label><select id="salesName"><option value="Willa">Willa</option><option value="Melissa">Melissa</option><option value="Anita">Anita</option></select></div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px">
        <div class="form-group"><label>åˆç´„é–‹å§‹</label><input type="date" id="startDate" required></div>
        <div class="form-group"><label>åˆç´„çµæŸ</label><input type="date" id="endDate" required></div>
      </div>
      <div class="form-group" style="background:#f8fafc; padding:15px; border-radius:8px;">
        <label>æ’ç¨‹æœˆä»½</label>
        <div id="ymList" style="margin:10px 0; display:flex; flex-wrap:wrap; gap:5px;"></div>
        <div style="display:flex; gap:8px;"><input type="month" id="addYMInput"><button type="button" class="btn btn-outline" onclick="addYM()">æ–°å¢</button><button type="button" class="btn btn-outline" onclick="recalcSchedule()">è¨ˆç®—</button></div>
      </div>
      <div class="form-group"><label>å‚™è¨»äº‹é …</label><div id="editor-container"></div></div>
      <button type="submit" class="btn btn-primary" style="width:100%">å„²å­˜è³‡æ–™</button>
      <button type="button" class="btn btn-outline" id="btnDelete" style="width:100%; margin-top:10px; color:var(--danger)">åˆªé™¤æ­¤ç´€éŒ„</button>
    </form>
  </div>

  <div class="overlay" id="modalOverlay" onclick="closeModal()"></div>
  <div class="modal" id="doneModal">
    <h3 id="mTitle" style="margin:0 0 1rem 0">ç¶­è­·å®Œå·¥å›å ±</h3>
    <div class="form-group"><label>åŸ·è¡Œå·¥ç¨‹å¸«</label><select id="mEngName"><option value="Willa">Willa</option><option value="Charlie">Charlie</option></select></div>
    <div class="form-group"><label>å®Œå·¥æ—¥æœŸ</label><input type="date" id="mDoneDate"></div>
    <div style="display:flex; gap:10px; margin-top:1.5rem"><button id="btnConfirmDone" class="btn btn-primary" style="flex:1">ç¢ºèªé€å‡º</button><button onclick="closeModal()" class="btn btn-outline" style="flex:1">å–æ¶ˆ</button></div>
  </div>

  <script>
    // --- åŸºç¤è¨­å®š ---
    const urlParams = new URLSearchParams(window.location.search);
    let mode = urlParams.get('mode') || 'user'; // ä½¿ç”¨ let å…è¨±åˆ‡æ›æ¨¡å¼
    const API_URL = "https://script.google.com/macros/s/AKfycbznmfZ1quMslZxY6dftt_83uYqUGTh9THmoIO4LdFx7O9CPl0eKn2vvLP0YqM9nv2jf/exec?token=otsukakh5501398";

    let records = [];
    let editingId = null;
    let editingYMList = [];
    let quill;
    let modalTarget = null;

    const esc = (t) => String(t || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

    // --- 1. åˆå§‹åŒ–èˆ‡è¼‰å…¥ ---
    async function load() {
        // è¨­å®šé è¨­æœˆä»½ç‚ºç•¶æœˆ
        const now = new Date();
        const currentYM = now.toISOString().slice(0, 7);
        document.getElementById('monthPick').value = currentYM;

        let pwd = sessionStorage.getItem('sys_pwd');
        if (!pwd) pwd = prompt("ğŸ”’ æ­¤ç‚ºç§äººç³»çµ±ï¼Œè«‹è¼¸å…¥å­˜å–å¯†ç¢¼ï¼š");

        if (!pwd) {
            document.body.innerHTML = "<h2 style='text-align:center;margin-top:50px;'>è«‹è¼¸å…¥å¯†ç¢¼å¾Œé‡æ–°æ•´ç†ç¶²é ã€‚</h2>";
            document.body.style.display = "block";
            return;
        }

        try {
            const resp = await fetch(`${API_URL}&pwd=${encodeURIComponent(pwd)}`);
            const data = await resp.json();

            if (data && data.status === "error") {
                alert("å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†ç¶²é ");
                sessionStorage.removeItem('sys_pwd');
                return;
            }

            sessionStorage.setItem('sys_pwd', pwd);
            records = Array.isArray(data) ? data : [];
            
            // åˆå§‹åŒ– Quill
            quill = new Quill('#editor-container', { theme: 'snow' });
            
            document.body.className = 'mode-' + mode;
            document.body.style.display = "block";
            render();
        } catch (e) {
            console.error(e);
            alert("è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API æ¬Šé™ã€‚");
        }
    }

    // --- 2. æ ¸å¿ƒæ¸²æŸ“é‚è¼¯ ---
    function render() {
        const ym = document.getElementById('monthPick').value;
        const q = document.getElementById('q').value.toLowerCase();
        const scope = document.getElementById('scope').value;
        const tbody = document.getElementById('rows');

        let filtered = records.filter(r => {
            const hasSch = (r.schedule || []).some(s => s.ym === ym);
            const textMatch = !q || r.customer.toLowerCase().includes(q) || (r.salesName || "").toLowerCase().includes(q);
            return (scope === 'need' ? hasSch : true) && textMatch;
        });

        filtered.sort((a, b) => (a.customer || "").localeCompare(b.customer, 'zh-Hant'));

        // æ›´æ–°çµ±è¨ˆæ•¸å­—
        document.getElementById('statTotal').textContent = records.length;
        document.getElementById('statDone').textContent = filtered.filter(r => (r.schedule || []).some(s => s.ym === ym && s.isDone)).length;
        document.getElementById('statTodo').textContent = filtered.filter(r => (r.schedule || []).some(s => s.ym === ym && !s.isDone)).length;

        tbody.innerHTML = '';
        filtered.forEach(r => {
            const sch = (r.schedule || []).find(s => s.ym === ym);
            const hasNote = r.notes && r.notes.replace(/<[^>]*>/g, '').trim().length > 0;

            tbody.insertAdjacentHTML('beforeend', `
                <tr>
                    <td>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <span style="font-weight:700;">${esc(r.customer)}</span>
                            ${hasNote ? `<span class="material-symbols-rounded note-trigger" onclick="viewNote('${r.id}')">description</span>` : ''}
                        </div>
                    </td>
                    <td><div style="font-size:0.75rem;">${esc(r.product)}</div><span class="sales-tag">${esc(r.salesName)}</span></td>
                    <td><div style="font-size:0.8rem; color:var(--text-muted);">${esc(r.startDate)} <br>è‡³ ${esc(r.endDate)}</div></td>
                    <td>
                        <div style="display:flex; flex-wrap:wrap; gap:4px;">
                            ${(r.schedule || []).map(s => `
                                <span class="month-chip ${s.isDone ? 'is-done' : ''} ${s.ym === ym ? 'active' : ''}">
                                    ${s.ym.slice(5)}æœˆ
                                </span>
                            `).join('')}
                        </div>
                    </td>
                    <td onclick="handleStatusClick('${r.id}', '${ym}')" style="cursor:pointer">
                        ${sch ? (
                            sch.isDone 
                            ? `<span style="color:var(--success); font-weight:600">å·²å®Œå·¥</span><br><span class="eng-tag">${esc(sch.engName)}</span>` 
                            : `<span style="color:var(--warning); font-weight:600; display:inline-flex; align-items:center; gap:4px;"><span class="material-symbols-rounded" style="font-size:16px;">priority_high</span>å¾…ç¶­è­·</span>`
                        ) : '<span style="color:#cbd5e1">--</span>'}
                    </td>
                    <td>
                        <div style="display:flex; gap:5px;">
                            ${sch ? `<button class="btn btn-outline" style="padding:6px; height:34px" onclick="handleStatusClick('${r.id}', '${ym}')"><span class="material-symbols-rounded">${sch.isDone ? 'settings_backup_restore' : 'done_all'}</span></button>` : ''}
                            ${mode === 'admin' ? `<button class="btn btn-outline" style="padding:6px; height:34px" onclick="openEdit('${r.id}')"><span class="material-symbols-rounded">edit</span></button>` : ''}
                        </div>
                    </td>
                </tr>
            `);
        });
        document.getElementById('btnNew').style.display = mode === 'admin' ? '' : 'none';
    }

    // --- 3. åŠŸèƒ½å‡½å¼ ---
    window.viewNote = (id) => {
        const r = records.find(x => x.id === id);
        if(!r) return;
        document.getElementById('noteTitle').textContent = r.customer + " - å‚™è¨»";
        document.getElementById('noteContent').innerHTML = r.notes || "ç„¡å…§å®¹";
        document.getElementById('noteDrawer').classList.add('open');
        document.getElementById('overlay').style.display = 'block';
    };

    window.openEdit = (id = null) => {
        editingId = id;
        const r = records.find(x => x.id === id) || { customer: "", product: "ee-class", salesName: "Willa", startDate: "", endDate: "", notes: "", schedule: [] };
        
        document.getElementById('drawerTitle').textContent = id ? "ç·¨è¼¯å®¢æˆ¶" : "æ–°å¢å®¢æˆ¶";
        document.getElementById('customer').value = r.customer;
        document.getElementById('product').value = r.product;
        document.getElementById('salesName').value = r.salesName || "Willa";
        document.getElementById('startDate').value = r.startDate;
        document.getElementById('endDate').value = r.endDate;
        quill.root.innerHTML = r.notes || "";
        editingYMList = (r.schedule || []).map(s => s.ym).sort();
        
        renderYMChips();
        document.getElementById('editDrawer').classList.add('open');
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('btnDelete').style.display = id ? 'block' : 'none';
    };

    window.handleStatusClick = (id, ym) => {
        const r = records.find(x => x.id === id);
        if (!r) return;
        const sch = (r.schedule || []).find(s => s.ym === ym);
        if (!sch) return;

        if (sch.isDone) {
            if (confirm("ç¢ºå®šè¦æ¢å¾©ç‚ºã€Œå¾…ç¶­è­·ã€å—ï¼Ÿ")) {
                sch.isDone = false;
                saveAll();
            }
        } else {
            modalTarget = { id, ym };
            document.getElementById('mTitle').textContent = r.customer + " - å®Œå·¥å›å ±";
            document.getElementById('mDoneDate').value = new Date().toISOString().slice(0, 10);
            document.getElementById('doneModal').style.display = 'block';
            document.getElementById('modalOverlay').style.display = 'block';
        }
    };

    async function saveAll() {
        const currentPwd = sessionStorage.getItem('sys_pwd');
        const urlWithAuth = `${API_URL}&pwd=${encodeURIComponent(currentPwd)}`;
        try {
            await fetch(urlWithAuth, { method: "POST", body: JSON.stringify(records) });
            render();
        } catch (e) {
            alert("å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
        }
    }

    window.closeAllDrawers = () => {
        document.querySelectorAll('.drawer').forEach(d => d.classList.remove('open'));
        document.getElementById('overlay').style.display = 'none';
    };

    window.closeModal = () => {
        document.getElementById('doneModal').style.display = 'none';
        document.getElementById('modalOverlay').style.display = 'none';
    };

    window.renderYMChips = () => {
        document.getElementById('ymList').innerHTML = editingYMList.map(ym => `
            <span class="month-chip active" style="padding:4px 8px; font-size:0.9rem">
                ${ym} <span style="cursor:pointer;margin-left:5px" onclick="removeYM('${ym}')">Ã—</span>
            </span>
        `).join('');
    };

    window.removeYM = (ym) => {
        editingYMList = editingYMList.filter(x => x !== ym);
        renderYMChips();
    };

    window.addYM = () => {
        const v = document.getElementById('addYMInput').value;
        if (v && !editingYMList.includes(v)) {
            editingYMList.push(v);
            editingYMList.sort();
            renderYMChips();
        }
    };

    window.recalcSchedule = () => {
        const start = new Date(document.getElementById('startDate').value);
        const end = new Date(document.getElementById('endDate').value);
        if (isNaN(start) || isNaN(end)) return;
        editingYMList = [];
        let cur = new Date(start);
        cur.setMonth(cur.getMonth() + 2); // ç¬¬ä¸€æ¬¡ç¶­è­·é€šå¸¸åœ¨å…©å€‹æœˆå¾Œ
        while (cur <= end) {
            editingYMList.push(cur.toISOString().slice(0, 7));
            cur.setMonth(cur.getMonth() + 3); // æ¯ä¸‰å€‹æœˆä¸€æ¬¡
        }
        renderYMChips();
    };

    // --- 4. äº‹ä»¶ç¶å®š ---
    document.getElementById('formEdit').onsubmit = async (e) => {
        e.preventDefault();
        const rData = {
            id: editingId || 'ID-' + Date.now(),
            customer: document.getElementById('customer').value,
            product: document.getElementById('product').value,
            salesName: document.getElementById('salesName').value,
            startDate: document.getElementById('startDate').value,
            endDate: document.getElementById('endDate').value,
            notes: quill.root.innerHTML,
            schedule: editingYMList.map(ym => {
                const old = (records.find(x => x.id === editingId)?.schedule || []).find(s => s.ym === ym);
                return old || { ym, isDone: false, engName: "" };
            })
        };
        if (!editingId) records.push(rData);
        else records[records.findIndex(x => x.id === editingId)] = rData;
        
        await saveAll();
        closeAllDrawers();
    };

    document.getElementById('btnConfirmDone').onclick = async () => {
        if (!modalTarget) return;
        const r = records.find(x => x.id === modalTarget.id);
        const sch = r.schedule.find(s => s.ym === modalTarget.ym);
        sch.isDone = true;
        sch.engName = document.getElementById('mEngName').value;
        sch.doneDate = document.getElementById('mDoneDate').value;
        await saveAll();
        closeModal();
    };

    document.getElementById('modeSeg').onclick = (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        mode = btn.dataset.mode;
        document.body.className = 'mode-' + mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.toggle('active', b.dataset.mode === mode));
        render();
    };

    document.getElementById('q').oninput = render;
    document.getElementById('monthPick').onchange = render;
    document.getElementById('scope').onchange = render;
    document.getElementById('btnNew').onclick = () => openEdit();

    // å•Ÿå‹•
    load();
  </script>
</body>
</html>
