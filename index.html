<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å®¢æˆ¶ç¶­è­·ç®¡ç†ç³»çµ±</title>
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <style>
    :root {
      --primary: #4361ee; --primary-light: #eef2ff; --success: #10b981;
      --success-light: #e8f7f0; --success-dark: #065f46;
      --warning: #f59e0b; --danger: #ef4444; --text-main: #1e293b;
      --text-muted: #64748b; --bg-body: #f8fafc; --card-bg: #ffffff;
      --border: #e2e8f0; --radius-lg: 16px; --radius-md: 12px;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    * { box-sizing: border-box; }
    body { display: none; margin: 0; font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: var(--bg-body); color: var(--text-main); }
    
    header { background: var(--card-bg); border-bottom: 1px solid var(--border); padding: 0.75rem 1.5rem; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; }
    .logo { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 1.25rem; color: var(--primary); }
    
    #versionTag { margin-left: 8px; font-size: 11px; color: var(--primary); background: var(--primary-light); padding: 3px 8px; border-radius: 20px; font-weight: 600; cursor: pointer; border: 1px solid transparent; transition: 0.2s; }
    #versionTag:hover { border-color: var(--primary); box-shadow: 0 2px 4px rgba(67, 97, 238, 0.2); }

    main { max-width: 1550px; margin: 1.5rem auto; padding: 0 1rem; }
    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.25rem; margin-bottom: 1.5rem; }
    .stat-card { background: var(--card-bg); padding: 1.25rem; border-radius: var(--radius-lg); box-shadow: var(--shadow); display: flex; align-items: center; gap: 1rem; border: 1px solid var(--border); }
    .stat-icon { width: 50px; height: 50px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .stat-info .stat-label { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 2px; }
    .stat-info .stat-value { font-size: 2.2rem; font-weight: 800; line-height: 1; color: #334155; }

    .controls { display: flex; gap: 0.75rem; margin-bottom: 1rem; align-items: center; }
    .search-wrapper { flex: 1; position: relative; }
    
    .btn { padding: 8px 16px; border-radius: var(--radius-md); border: none; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; font-size: 0.9rem; transition: 0.2s; }
    .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-main); }
    .btn-primary { background: var(--primary); color: white; }

    .table-container { background: var(--card-bg); border-radius: var(--radius-lg); box-shadow: var(--shadow); overflow: hidden; border: 1px solid var(--border); }
    table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    th { background: #f8fafc; padding: 12px 16px; font-size: 0.85rem; color: var(--text-muted); text-align: left; border-bottom: 1px solid var(--border); }
    td { padding: 12px 16px; border-bottom: 1px solid var(--border); vertical-align: middle; }
    
    .col-customer { width: 18%; }
    .col-product  { width: 12%; }
    .col-period   { width: 15%; }
    .col-schedule { width: 34%; } 
    .col-status   { width: 11%; }
    .col-action   { width: 10%; }
    th.col-action { text-align: right; padding-right: 24px; }

    .sales-tag { background: #e0e7ff; color: #4338ca; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; display: inline-block; margin-top: 4px; }
    .month-group { display: flex; flex-wrap: wrap; gap: 3px; }
    .month-chip { padding: 2px 4px; border-radius: 3px; font-size: 11px; background: #f1f5f9; color: var(--text-muted); border: 1px solid var(--border); min-width: 32px; text-align: center; }
    .month-chip.is-done { background: var(--success-light); color: var(--success-dark); border-color: #a7f3d0; }
    .month-chip.active { border: 1.5px solid var(--primary); font-weight: 700; color: var(--primary); background: #fff; }

    .done-status-box { background: var(--success-light); color: var(--success-dark); padding: 6px 12px; border-radius: 8px; border: 1px solid #c6f6d5; display: inline-flex; flex-direction: column; min-width: 105px; }
    .done-status-box .status-title { font-size: 1rem; font-weight: 800; display: flex; align-items: center; gap: 4px; }
    .done-status-box .status-meta { font-size: 11px; opacity: 0.85; }

    .note-indicator { color: #94a3b8; cursor: pointer; margin-left: 6px; vertical-align: middle; font-size: 18px; }

    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 999; display: none; }
    .drawer { position: fixed; right: -100%; top: 0; width: 100%; max-width: 650px; height: 100%; background: white; z-index: 1000; transition: right 0.3s ease; padding: 2rem; overflow-y: auto; }
    .drawer.open { right: 0; }
    .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: white; padding: 1.5rem; border-radius: var(--radius-lg); z-index: 1100; width: 90%; max-width: 450px; display: none; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
    
    #editor-container { font-size: 16px; height: 400px; background: white; }
    .changelog-content { max-height: 400px; overflow-y: auto; padding: 10px; line-height: 1.6; border: 1px solid var(--border); border-radius: 8px; margin: 15px 0; background: #fafafa; }
  </style>
</head>
<body>

  <header>
    <div class="logo">
      <span class="material-symbols-rounded">analytics</span> 
      å®¢æˆ¶ç¶­è­·ç®¡ç†ç³»çµ±
      <span id="versionTag" onclick="showVersionLog()">v6.01091700</span>
    </div>
    <div style="display:flex; gap:10px;">
      <div id="modeSeg" style="display:flex; background:var(--primary-light); padding:4px; border-radius:100px;">
        <button class="mode-btn btn active" data-mode="user">æª¢è¦–æ¨¡å¼</button>
        <button class="mode-btn btn" data-mode="admin">ç®¡ç†æ¨¡å¼</button>
      </div>
      <div id="adminControls" style="display:none; gap:10px;">
        <button class="btn btn-outline" onclick="openVersionEditor()"><span class="material-symbols-rounded">history_edu</span>ç·¨è¼¯æ›´æ–°å…§å®¹</button>
        <button class="btn btn-primary" onclick="openEdit()"><span class="material-symbols-rounded">add</span>æ–°å¢ç¶­è­·</button>
      </div>
    </div>
  </header>

  <main>
    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-icon" style="background:#eef2ff; color:var(--primary);"><span class="material-symbols-rounded">groups</span></div>
        <div class="stat-info"><div class="stat-label">ç¸½å®¢æˆ¶æ•¸</div><div class="stat-value" id="statTotal">0</div></div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background:var(--success-light); color:var(--success);"><span class="material-symbols-rounded">check_circle</span></div>
        <div class="stat-info"><div class="stat-label" id="statDoneLabel">æœ¬æœˆå·²å®Œå·¥</div><div class="stat-value" id="statDone">0</div></div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background:#fff7ed; color:var(--warning);"><span class="material-symbols-rounded">pending_actions</span></div>
        <div class="stat-info"><div class="stat-label" id="statTodoLabel">æœ¬æœˆå¾…è™•ç†</div><div class="stat-value" id="statTodo">0</div></div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background:#f0fdf4; color:#15803d;"><span class="material-symbols-rounded">query_stats</span></div>
        <div class="stat-info"><div class="stat-label">æœ¬æœˆé”æˆç‡</div><div class="stat-value" id="statRate">0%</div></div>
      </div>
    </div>

    <div class="controls">
      <div class="search-wrapper">
        <span class="material-symbols-rounded" style="position:absolute; left:12px; top:50%; transform:translateY(-50%); color:var(--text-muted);">search</span>
        <input type="text" id="q" placeholder="æœå°‹å®¢æˆ¶åç¨±ã€æ¥­å‹™ã€ç”¢å“..." style="width:100%; padding:10px 16px 10px 40px; border-radius:var(--radius-md); border:1px solid var(--border); outline:none;">
      </div>
      <input type="month" id="monthPick" class="btn btn-outline">
      <select id="scope" class="btn btn-outline">
        <option value="all">é¡¯ç¤ºå…¨éƒ¨</option>
        <option value="need" selected>æœ¬æœˆç¶­è­·</option>
      </select>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th class="col-customer">å®¢æˆ¶åç¨±</th>
            <th class="col-product">ç”¢å“ / æ¥­å‹™</th>
            <th class="col-period">ç¶­è­·æœŸé–“</th>
            <th class="col-schedule">å…¨æœŸé€²åº¦</th>
            <th class="col-status">ç‹€æ…‹</th>
            <th class="col-action">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </main>

  <div class="overlay" id="overlay" onclick="closeDrawer()"></div>
  
  <div class="drawer" id="drawer">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
      <h2 id="drawerTitle" style="margin:0">ç¶­è­·ç·¨è¼¯</h2>
      <button class="btn btn-outline" style="padding:5px; border-radius:50%" onclick="closeDrawer()"><span class="material-symbols-rounded">close</span></button>
    </div>
    <form id="formEdit">
      <div id="adminOnlyFields">
        <div style="margin-bottom:12px;"><label style="font-size:0.85rem; font-weight:600;">å®¢æˆ¶åç¨±</label><input type="text" id="customer" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;" required></div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px;">
          <div><label style="font-size:0.85rem;">ç”¢å“</label><select id="product" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border);"><option value="ee-class">ee-class</option><option value="Adobe Connect">Adobe Connect</option><option value="km+">km+</option><option value="tms+">tms+</option></select></div>
          <div><label style="font-size:0.85rem;">æ¥­å‹™</label><select id="salesName" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border);"><option value="Willa">Willa</option><option value="Melissa">Melissa</option><option value="Anita">Anita</option></select></div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px;">
          <div><label style="font-size:0.85rem;">ç¶­è­·èµ·æ—¥</label><input type="date" id="startDate" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border);" onchange="handleDateChange()"></div>
          <div><label style="font-size:0.85rem;">ç¶­è­·è¨–æ—¥</label><input type="date" id="endDate" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border);"></div>
        </div>
        <div class="ym-manager">
          <label style="font-size:0.85rem; font-weight:600;">ç¶­è­·æœˆä»½ç®¡ç†</label>
          <div style="display:flex; gap:5px; margin-top:5px;">
            <input type="month" id="manualYM" class="btn btn-outline" style="flex:1">
            <button type="button" class="btn btn-outline" onclick="addYM()">æ‰‹å‹•æ–°å¢</button>
          </div>
          <div class="ym-list" id="ymList"></div>
        </div>
      </div>

      <div style="margin-top:20px; margin-bottom:12px;">
        <label id="noteLabel" style="font-size:0.85rem; font-weight:600;">å…§å®¹ç·¨è¼¯</label>
        <div id="editor-wrapper"><div id="editor-container"></div></div>
        <div id="note-viewer" style="display:none; padding:15px; border:1px solid var(--border); border-radius:8px; background:#fff; min-height:100px;"></div>
      </div>

      <div id="adminAction" style="display:none;">
        <button type="submit" class="btn btn-primary" style="width:100%; padding:12px;">å„²å­˜ä¸¦åŒæ­¥è‡³è³‡æ–™åº«</button>
        <button type="button" id="btnDelete" class="btn btn-outline" style="width:100%; margin-top:10px; color:var(--danger);">åˆªé™¤ç´€éŒ„</button>
      </div>
    </form>
  </div>

  <div class="modal" id="doneModal">
    <h3 style="margin-top:0;">å®Œå·¥ç”³å ±</h3>
    <div style="margin-bottom:10px;"><label>å¯¦éš›å®Œå·¥æ—¥</label><input type="date" id="mDoneDate" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;"></div>
    <div style="margin-bottom:15px;"><label>ç¶­è­·å·¥ç¨‹å¸«</label><select id="mEngName" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;"><option value="Willa">Willa</option><option value="Charlie">Charlie</option></select></div>
    <div style="display:flex; gap:10px;"><button id="mSave" class="btn btn-primary" style="flex:1;">æäº¤</button><button onclick="closeModal()" class="btn btn-outline" style="flex:1;">å–æ¶ˆ</button></div>
  </div>

  <div class="modal" id="versionModal">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0;">ç³»çµ±æ›´æ–°æ—¥èªŒ</h3>
      <span id="modalVerTag" style="font-size:12px; color:var(--text-muted);"></span>
    </div>
    <div class="changelog-content" id="changelogHtml">è®€å–ä¸­...</div>
    <button onclick="closeModal()" class="btn btn-primary" style="width:100%;">é—œé–‰è¦–çª—</button>
  </div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbznmfZ1quMslZxY6dftt_83uYqUGTh9THmoIO4LdFx7O9CPl0eKn2vvLP0YqM9nv2jf/exec?token=otsukakh5501398";
  const ADMIN_PASSWORD = "admin5501398";
  const VERSION_ID = "SYSTEM_LOG_v6"; // ç‰¹æ®Š ID
  
  let records = [], mode = "user", editingId = null, quill, modalTarget = null, editingYMList = [];

  async function load() {
    let pwd = sessionStorage.getItem('sys_pwd') || prompt("ğŸ”’ è«‹è¼¸å…¥ç³»çµ±å¯†ç¢¼ï¼š");
    if (!pwd) { location.reload(); return; }
    try {
      const resp = await fetch(`${API_URL}&pwd=${encodeURIComponent(pwd)}`);
      const data = await resp.json();
      if (data.status === "error") { sessionStorage.removeItem('sys_pwd'); location.reload(); return; }
      sessionStorage.setItem('sys_pwd', pwd);
      records = data; 
      document.body.style.display = "block"; 
      render();
    } catch (e) { alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚"); }
  }

  function showVersionLog() {
    const logData = records.find(r => r.id === VERSION_ID);
    document.getElementById('modalVerTag').textContent = document.getElementById('versionTag').textContent;
    document.getElementById('changelogHtml').innerHTML = logData ? logData.notes : "å°šç„¡æ›´æ–°ç´€éŒ„ï¼Œè«‹é€²å…¥ç®¡ç†æ¨¡å¼ç·¨è¼¯ã€‚";
    document.getElementById('versionModal').style.display = 'block';
    document.getElementById('overlay').style.display = 'block';
  }

  function openVersionEditor() {
    editingId = VERSION_ID;
    const logData = records.find(r => r.id === VERSION_ID) || { id: VERSION_ID, notes: "" };
    document.getElementById('drawerTitle').textContent = "ç·¨è¼¯ç³»çµ±æ—¥èªŒ";
    document.getElementById('adminOnlyFields').style.display = 'none';
    document.getElementById('btnDelete').style.display = 'none';
    document.getElementById('adminAction').style.display = 'block';
    document.getElementById('noteLabel').textContent = "æ—¥èªŒå…§å®¹ (æ”¯æ´ HTML æ’ç‰ˆ)";
    document.getElementById('editor-wrapper').style.display = 'block';
    document.getElementById('note-viewer').style.display = 'none';
    quill.root.innerHTML = logData.notes || "";
    document.getElementById('drawer').classList.add('open');
    document.getElementById('overlay').style.display = 'block';
  }

  function handleDateChange() {
    const startVal = document.getElementById('startDate').value;
    if(!startVal) return;
    const startDate = new Date(startVal);
    const endDate = new Date(startVal);
    endDate.setFullYear(startDate.getFullYear() + 1);
    endDate.setDate(endDate.getDate() - 1);
    document.getElementById('endDate').value = endDate.toISOString().slice(0, 10);
    editingYMList = [];
    [3, 6, 9, 12].forEach(offset => {
      const d = new Date(startDate.getFullYear(), startDate.getMonth() + offset, 1);
      editingYMList.push(d.toISOString().slice(0, 7));
    });
    renderYMList();
  }

  function addYM() {
    const val = document.getElementById('manualYM').value;
    if(val && !editingYMList.includes(val)) {
      editingYMList.push(val);
      editingYMList.sort();
      renderYMList();
    }
  }

  function removeYM(ym) {
    editingYMList = editingYMList.filter(x => x !== ym);
    renderYMList();
  }

  function renderYMList() {
    const container = document.getElementById('ymList');
    container.innerHTML = editingYMList.map(ym => `
      <div class="ym-tag">${ym} <span onclick="removeYM('${ym}')" style="cursor:pointer; color:var(--danger); font-weight:bold;">Ã—</span></div>
    `).join('');
  }

  function render() {
    const ym = document.getElementById('monthPick').value || new Date().toISOString().slice(0, 7);
    const currentYM = new Date().toISOString().slice(0, 7);
    const q = document.getElementById('q').value.toLowerCase();
    const scope = document.getElementById('scope').value;

    const mainRecords = records.filter(r => r.id !== VERSION_ID);
    const filtered = mainRecords.filter(r => {
      const match = !q || r.customer.toLowerCase().includes(q) || (r.salesName||"").toLowerCase().includes(q) || r.product.toLowerCase().includes(q);
      const hasSch = (r.schedule || []).some(s => s.ym === ym);
      return (scope === 'need' ? hasSch : true) && match;
    }).sort((a,b) => a.customer.localeCompare(b.customer, 'zh-Hant'));

    document.getElementById('statTotal').textContent = mainRecords.length;
    const doneCount = mainRecords.filter(r => r.schedule?.some(s => s.ym === ym && (s.isDone || s.ym < currentYM))).length;
    const todoCount = mainRecords.filter(r => r.schedule?.some(s => s.ym === ym && (!s.isDone && s.ym >= currentYM))).length;
    const rate = (doneCount + todoCount) > 0 ? Math.round((doneCount / (doneCount + todoCount)) * 100) : 0;

    document.getElementById('statDone').textContent = doneCount;
    document.getElementById('statTodo').textContent = todoCount;
    document.getElementById('statRate').textContent = rate + "%";

    const tbody = document.getElementById('rows');
    tbody.innerHTML = '';

    filtered.forEach(r => {
      const sch = (r.schedule || []).find(s => s.ym === ym);
      const hasNotes = r.notes && r.notes !== '<p><br></p>';
      
      tbody.insertAdjacentHTML('beforeend', `
        <tr>
          <td><span style="font-weight:700;">${r.customer}</span>${hasNotes ? `<span class="material-symbols-rounded note-indicator" onclick="openEdit('${r.id}', true)">description</span>` : ''}</td>
          <td><div style="font-size:0.8rem; color:var(--text-muted);">${r.product}</div><span class="sales-tag">${r.salesName}</span></td>
          <td style="font-size:0.85rem; color:var(--text-muted);">${r.startDate} ~ ${r.endDate}</td>
          <td>
            <div class="month-group">
              ${(r.schedule || []).map(s => {
                const isPast = s.ym < currentYM;
                return `<span class="month-chip ${(s.isDone || isPast) ? 'is-done' : ''} ${s.ym === ym ? 'active' : ''}">${parseInt(s.ym.slice(5))}æœˆ</span>`;
              }).join('')}
            </div>
          </td>
          <td>
            ${sch ? ((sch.isDone || sch.ym < currentYM) ? `
              <div class="done-status-box">
                <div class="status-title"><span class="material-symbols-rounded" style="font-size:18px;">check_circle</span>å®Œå·¥</div>
                <div class="status-meta">${sch.doneDate || 'ç³»çµ±'}<br>${sch.engName || 'Auto'}</div>
              </div>
            ` : `<span style="color:var(--warning); font-weight:700; display:flex; align-items:center; gap:4px;"><span class="material-symbols-rounded" style="font-size:16px;">pending</span>å¾…ç¶­è­·</span>`) : '--'}
          </td>
          <td>
            <div style="display:flex; gap:6px; justify-content: flex-end;">
              ${sch ? `<button class="btn btn-outline" style="padding:4px" onclick="toggleDone('${r.id}','${ym}')"><span class="material-symbols-rounded" style="font-size:18px;">${(sch.isDone || sch.ym < currentYM)?'history':'done'}</span></button>` : ''}
              ${mode === 'admin' ? `<button class="btn btn-outline" style="padding:4px" onclick="openEdit('${r.id}')"><span class="material-symbols-rounded" style="font-size:18px;">edit</span></button>` : ''}
            </div>
          </td>
        </tr>
      `);
    });
  }

  function openEdit(id = null, forceReadOnly = false) {
    editingId = id;
    const r = records.find(x => x.id === id) || { customer:"", product:"ee-class", salesName:"Willa", startDate:"", endDate:"", notes:"", schedule: [] };
    const isViewOnly = forceReadOnly || mode === 'user';
    document.getElementById('adminOnlyFields').style.display = isViewOnly ? 'none' : 'block';
    document.getElementById('adminAction').style.display = isViewOnly ? 'none' : 'block';
    document.getElementById('btnDelete').style.display = (isViewOnly || !id) ? 'none' : 'block';
    document.getElementById('noteLabel').textContent = "ç¶­è­·å‚™è¨»";
    document.getElementById('drawerTitle').textContent = isViewOnly ? "å‚™è¨»å…§å®¹" : (id ? "ç·¨è¼¯ç¶­è­·" : "æ–°å¢ç¶­è­·");
    
    if(isViewOnly) {
      document.getElementById('editor-wrapper').style.display = 'none';
      document.getElementById('note-viewer').style.display = 'block';
      document.getElementById('note-viewer').innerHTML = r.notes || '<span style="color:#94a3b8">å°šç„¡å‚™è¨»</span>';
    } else {
      document.getElementById('editor-wrapper').style.display = 'block';
      document.getElementById('note-viewer').style.display = 'none';
      quill.root.innerHTML = r.notes || "";
    }
    
    document.getElementById('customer').value = r.customer || "";
    document.getElementById('product').value = r.product || "ee-class";
    document.getElementById('salesName').value = r.salesName || "Willa";
    document.getElementById('startDate').value = r.startDate || "";
    document.getElementById('endDate').value = r.endDate || "";
    editingYMList = (r.schedule || []).map(s => s.ym);
    renderYMList();
    document.getElementById('drawer').classList.add('open');
    document.getElementById('overlay').style.display = 'block';
  }

  async function save() {
    const pwd = sessionStorage.getItem('sys_pwd');
    const resp = await fetch(`${API_URL}&pwd=${encodeURIComponent(pwd)}`, { 
      method: "POST", 
      body: JSON.stringify(records) 
    });
    const res = await resp.json();
    if(res.status === 'success') {
      render();
    } else {
      throw new Error("API Save Failed");
    }
  }

  // --- é—œéµä¿®æ­£ï¼šç¢ºä¿å„²å­˜çµæ§‹å®Œæ•´ ---
  document.getElementById('formEdit').onsubmit = async (e) => {
    e.preventDefault();
    const currentYM = new Date().toISOString().slice(0, 7);
    
    let targetData;
    if (editingId === VERSION_ID) {
      // æ¨¡æ“¬æ™®é€šå®¢æˆ¶æ ¼å¼ä¾†å„²å­˜æ—¥èªŒï¼Œé˜²æ­¢ Apps Script å ±éŒ¯
      targetData = {
        id: VERSION_ID,
        customer: "ç³»çµ±æ›´æ–°æ—¥èªŒ(ç³»çµ±ç´€éŒ„)",
        product: "SYSTEM",
        salesName: "Admin",
        startDate: "2020-01-01",
        endDate: "2099-12-31",
        notes: quill.root.innerHTML,
        schedule: []
      };
    } else {
      targetData = {
        id: editingId || 'ID-' + Date.now(),
        customer: document.getElementById('customer').value,
        product: document.getElementById('product').value,
        salesName: document.getElementById('salesName').value,
        startDate: document.getElementById('startDate').value,
        endDate: document.getElementById('endDate').value,
        notes: quill.root.innerHTML === '<p><br></p>' ? '' : quill.root.innerHTML,
        schedule: editingYMList.map(ym => {
          const old = (records.find(x => x.id === editingId)?.schedule || []).find(s => s.ym === ym);
          if (old) return old;
          const isPast = ym < currentYM;
          return { ym, isDone: isPast, doneDate: isPast ? currentYM : "", engName: isPast ? "Auto" : "" };
        })
      };
    }

    // æ›´æ–°å€åŸŸè®Šæ•¸ records
    const idx = records.findIndex(x => x.id === targetData.id);
    if (idx !== -1) records[idx] = targetData; else records.push(targetData);
    
    try {
      await save(); 
      closeDrawer();
      alert("å„²å­˜æˆåŠŸï¼è³‡æ–™å·²åŒæ­¥è‡³è³‡æ–™åº«ã€‚");
    } catch (err) { 
      alert("å„²å­˜å¤±æ•—ï¼šå¾Œç«¯æ‹’çµ•å¯«å…¥ã€‚è«‹ç¢ºèªæ‚¨çš„ç¶²è·¯é€£ç·šã€‚"); 
    }
  };

  function toggleDone(id, ym) {
    const r = records.find(x => x.id === id);
    const sch = r.schedule.find(s => s.ym === ym);
    const currentYM = new Date().toISOString().slice(0, 7);
    if(sch.isDone || sch.ym < currentYM) {
      if(confirm("ç¢ºå®šå–æ¶ˆå®Œå·¥ï¼Ÿ")) { sch.isDone = false; save(); }
    } else {
      modalTarget = { id, ym };
      document.getElementById('mDoneDate').value = new Date().toISOString().slice(0,10);
      document.getElementById('doneModal').style.display = 'block';
      document.getElementById('overlay').style.display = 'block';
    }
  }

  function closeDrawer() { document.getElementById('drawer').classList.remove('open'); document.getElementById('overlay').style.display = 'none'; closeModal(); }
  function closeModal() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); document.getElementById('overlay').style.display = 'none'; }

  document.getElementById('btnDelete').onclick = async () => {
    if(confirm("ç¢ºå®šåˆªé™¤æ­¤å®¢æˆ¶ï¼Ÿ")) { records = records.filter(x => x.id !== editingId); await save(); closeDrawer(); }
  };

  document.getElementById('mSave').onclick = async () => {
    const r = records.find(x => x.id === modalTarget.id);
    const sch = r.schedule.find(s => s.ym === modalTarget.ym);
    sch.isDone = true; 
    sch.engName = document.getElementById('mEngName').value; 
    sch.doneDate = document.getElementById('mDoneDate').value;
    await save(); closeModal();
  };

  document.getElementById('modeSeg').onclick = (e) => {
    const b = e.target.closest('button'); if(!b) return;
    if (b.dataset.mode === 'admin') {
      if (prompt("ç®¡ç†è€…å¯†ç¢¼ï¼š") !== ADMIN_PASSWORD) { alert("å¯†ç¢¼éŒ¯èª¤"); return; }
    }
    mode = b.dataset.mode;
    document.querySelectorAll('.mode-btn').forEach(x => x.classList.toggle('active', x===b));
    document.getElementById('adminControls').style.display = mode === 'admin' ? 'flex' : 'none';
    render();
  };

  document.addEventListener('DOMContentLoaded', () => {
    quill = new Quill('#editor-container', { 
      theme: 'snow', 
      modules: { 
        toolbar: [
          [{ 'size': ['small', false, 'large', 'huge'] }],
          ['bold', 'underline'], 
          [{ 'color': [] }, { 'background': [] }], 
          [{ 'list': 'ordered'}, { 'list': 'bullet' }], 
          ['clean'] 
        ] 
      } 
    });
    document.getElementById('monthPick').value = new Date().toISOString().slice(0, 7);
    load();
  });

  document.getElementById('q').oninput = render;
  document.getElementById('monthPick').onchange = render;
  document.getElementById('scope').onchange = render;
</script>
</body>
</html>
