<!doctype html>
<html lang="zh-Hant">
<head>
  <meta name="robots" content="noindex, nofollow, noarchive">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å®¢æˆ¶ç³»çµ±ç¶­è­·æ¸…å–®</title>
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <style>
    :root {
      --primary: #4361ee; --primary-light: #eef2ff; --success: #2ec4b6; --warning: #ff9f1c;
      --danger: #e71d36; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --text-muted: #64748b;
      --border: #e2e8f0; --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    * { box-sizing: border-box; }
    /* ä¿®æ”¹ Aï¼šé è¨­ç¶­æŒéš±è—ï¼Œé€šéé©—è­‰æ‰é¡¯ç¤º */
    body { display: none; margin: 0; font-family: 'Inter', 'Noto Sans TC', sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; }
    
    .container { max-width: 1450px; margin: 0 auto; padding: 20px; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 15px; }
    .page-title { font-size: 1.5rem; font-weight: 700; margin: 0; color: var(--primary); display: flex; align-items: center; gap: 8px; }

    .toolbar { background: var(--card); padding: 16px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 12px; align-items: center; border: 1px solid var(--border); }
    .search-box { position: relative; flex: 1; min-width: 200px; }
    .search-box input { width: 100%; padding: 10px 12px 10px 40px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.95rem; }
    .search-box .material-symbols-rounded { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }

    .table-container { background: var(--card); border-radius: 12px; box-shadow: var(--shadow); overflow: hidden; border: 1px solid var(--border); }
    table { width: 100%; border-collapse: collapse; text-align: left; table-layout: fixed; }
    th { background: #f1f5f9; padding: 12px 16px; font-weight: 600; font-size: 0.9rem; color: var(--text-muted); border-bottom: 1px solid var(--border); }
    td { padding: 16px; border-bottom: 1px solid var(--border); vertical-align: middle; }
    
    .col-customer { width: 22%; }
    .col-product  { width: 12%; }
    .col-period   { width: 18%; }
    .col-schedule { width: 30%; padding-right: 30px; }
    .col-status   { width: 10%; }
    .col-action   { width: 8%; }

    .cust-cell { display: flex; align-items: center; gap: 8px; }
    .note-trigger { color: var(--primary); cursor: pointer; transition: 0.2s; font-size: 20px; }
    .note-trigger:hover { color: #2b44b8; transform: scale(1.1); }

    .month-group { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; width: 100%; }
    .month-chip { padding: 2px 0; border-radius: 4px; font-size: 0.75rem; background: #f1f5f9; color: var(--text-muted); border: 1px solid var(--border); text-align: center; }
    .month-chip.active { border: 2px solid var(--primary); font-weight: 700; color: var(--primary); background: #fff; }
    .month-chip.is-done { background: #dcfce7; color: #166534; border-color: #bbf7d0; }

    .sales-tag { display: inline-block; padding: 1px 6px; border-radius: 4px; background: var(--primary-light); color: var(--primary); font-size: 0.7rem; font-weight: 500; margin-top: 4px; }
    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; border-radius: 8px; border: none; font-weight: 500; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-outline { background: white; border: 1px solid var(--border); color: var(--text); }

    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; z-index: 90; backdrop-filter: blur(2px); }
    .drawer { position: fixed; top: 0; right: -600px; width: 600px; height: 100%; background: white; z-index: 100; transition: 0.3s ease; padding: 24px; box-shadow: -4px 0 15px rgba(0,0,0,0.1); overflow-y: auto; }
    .drawer.open { right: 0; }
    .drawer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
    
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; color: var(--text-muted); }
    .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.95rem; }
    
    .view-notes-box { background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid var(--border); min-height: 200px; line-height: 1.8; }
    
    .editor-mchip { display: inline-flex; align-items: center; background: var(--primary-light); color: var(--primary); padding: 4px 10px; border-radius: 20px; font-size: 0.85rem; font-weight: 500; }
    .remove-btn { margin-left: 6px; cursor: pointer; color: var(--danger); font-weight: bold; }

    @media (max-width: 1200px) {
      .drawer { width: 100%; right: -100%; }
      table { table-layout: auto; }
    }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1 class="page-title"><span class="material-symbols-rounded">fact_check</span> å®¢æˆ¶ç³»çµ±ç¶­è­·æ¸…å–®</h1>
    <div style="display:flex; gap:10px;">
      <div id="modeSeg" style="display:flex; background:#e2e8f0; padding:4px; border-radius:8px;">
        <button class="mode-btn btn active" data-mode="user" style="padding:6px 12px; font-size:0.8rem;">æª¢è¦–æ¨¡å¼</button>
        <button class="mode-btn btn" data-mode="admin" style="padding:6px 12px; font-size:0.8rem;">ç®¡ç†æ¨¡å¼</button>
      </div>
      <button id="btnNew" class="btn btn-primary" style="display:none;"><span class="material-symbols-rounded">add_task</span>æ–°å¢ç¶­è­·</button>
    </div>
  </header>

  <div class="toolbar">
    <div class="search-box">
      <span class="material-symbols-rounded">search</span>
      <input type="text" id="q" placeholder="æœå°‹å®¢æˆ¶åç¨±æˆ–æ¥­å‹™...">
    </div>
    <div style="display:flex; gap:8px;">
      <select id="monthPick" class="btn btn-outline" style="padding:8px;"></select>
      <select id="scope" class="btn btn-outline" style="padding:8px;">
        <option value="all">é¡¯ç¤ºå…¨éƒ¨</option>
        <option value="need" selected>åƒ…é¡¯ç¤ºæœ¬æœˆéœ€ç¶­è­·</option>
      </select>
    </div>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th class="col-customer">å®¢æˆ¶åç¨±</th>
          <th class="col-product">ç”¢å“ / æ¥­å‹™</th>
          <th class="col-period">ç¶­è­·æœŸé–“</th>
          <th class="col-schedule">ç¶­è­·é€±æœŸ</th>
          <th class="col-status">ç‹€æ…‹</th>
          <th class="col-action">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</div>

<div class="overlay" id="overlay" onclick="closeAllDrawers()"></div>

<div class="drawer" id="noteDrawer">
  <div class="drawer-header">
    <h3 id="noteDrawerTitle" style="margin:0;">å®¢æˆ¶å‚™è¨»ç´€éŒ„</h3>
    <button class="btn btn-outline" onclick="closeAllDrawers()" style="padding:4px;"><span class="material-symbols-rounded">close</span></button>
  </div>
  <div id="noteContent" class="view-notes-box"></div>
</div>

<div class="drawer" id="editDrawer">
  <div class="drawer-header">
    <h3 id="drawerTitle" style="margin:0;">æ–°å¢ç¶­è­·</h3>
    <button class="btn btn-outline" onclick="closeAllDrawers()" style="padding:4px;"><span class="material-symbols-rounded">close</span></button>
  </div>
  <form id="formEdit">
    <div class="form-group"><label>å®¢æˆ¶åç¨±</label><input type="text" id="customer" required></div>
    <div style="display:flex; gap:10px;">
      <div class="form-group" style="flex:1;"><label>ç”¢å“ç·š</label>
        <select id="product">
          <option value="ee-class">ee-class</option>
          <option value="Adobe Connect">Adobe Connect</option>
          <option value="km+">km+</option>
          <option value="tms+">tms+</option>
        </select>
      </div>
      <div class="form-group" style="flex:1;"><label>è² è²¬æ¥­å‹™</label>
        <select id="salesName">
          <option value="Willa">Willa</option>
          <option value="Melissa">Melissa</option>
          <option value="Anita">Anita</option>
        </select>
      </div>
    </div>
    <div style="display:flex; gap:10px;">
      <div class="form-group" style="flex:1;"><label>èµ·å§‹æ—¥æœŸ</label><input type="date" id="startDate" required onchange="calcDefaultSchedule()"></div>
      <div class="form-group" style="flex:1;"><label>çµæŸæ—¥æœŸ</label><input type="date" id="endDate"></div>
    </div>
    
    <div class="form-group" style="background:#f8fafc; padding:12px; border-radius:8px; border:1px dashed #cbd5e1;">
      <label>ç¶­è­·æœˆä»½æ’ç¨‹</label>
      <div style="display:flex; gap:5px; margin-bottom:10px;">
        <input type="month" id="addYMInput" style="flex:1;">
        <button type="button" class="btn btn-outline" onclick="addYM()">åŠ å…¥</button>
      </div>
      <div id="ymList" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
    </div>

    <div class="form-group">
      <label>å‚™è¨»äº‹é …</label>
      <div id="editor-container" style="height:200px; background:white;"></div>
    </div>
    
    <div style="display:flex; gap:10px; margin-top:24px;">
      <button type="submit" class="btn btn-primary" style="flex:1;">å„²å­˜è³‡æ–™</button>
      <button type="button" id="btnDelete" class="btn btn-outline" style="color:var(--danger); border-color:var(--danger); display:none;">åˆªé™¤</button>
    </div>
  </form>
</div>

<div class="modal" id="doneModal" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:24px; border-radius:16px; z-index:110; display:none; width:350px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
  <h3 style="margin-top:0; font-size:1.1rem;">å®Œå·¥å›å ±</h3>
  <div class="form-group"><label>å·¥ç¨‹å¸«</label><select id="mEngName"><option value="Willa">Willa</option><option value="Charlie">Charlie</option></select></div>
  <div class="form-group"><label>å®Œå·¥æ—¥æœŸ</label><input type="date" id="mDoneDate"></div>
  <div style="display:flex; gap:10px; margin-top:20px;">
    <button class="btn btn-primary" id="btnConfirmDone" style="flex:1;">ç¢ºèª</button>
    <button class="btn btn-outline" onclick="closeModal()" style="flex:1;">å–æ¶ˆ</button>
  </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbznmfZ1quMslZxY6dftt_83uYqUGTh9THmoIO4LdFx7O9CPl0eKn2vvLP0YqM9nv2jf/exec?token=otsukakh5501398";
    let records = [], editingId = null, editingYMList = [], quill, modalTarget = null;
    let mode = new URLSearchParams(window.location.search).get('mode') || 'user';
    const esc = (t) => String(t || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

    async function load() {
        const now = new Date(), currentYM = now.toISOString().slice(0, 7);
        const monthPick = document.getElementById('monthPick');
        for(let i=-6; i<=18; i++) {
          const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
          const val = d.toISOString().slice(0, 7);
          monthPick.insertAdjacentHTML('beforeend', `<option value="${val}" ${val===currentYM?'selected':''}>${val}</option>`);
        }

        // ä¿®æ”¹ Aï¼šåš´æ ¼å¯†ç¢¼é©—è­‰
        let pwd = sessionStorage.getItem('sys_pwd');
        if (!pwd) pwd = prompt("ğŸ”’ è«‹è¼¸å…¥å­˜å–å¯†ç¢¼ï¼š");

        if (!pwd) {
            alert("å¿…é ˆè¼¸å…¥å¯†ç¢¼ã€‚");
            location.reload();
            return;
        }

        try {
            const resp = await fetch(`${API_URL}&pwd=${encodeURIComponent(pwd)}`);
            const data = await resp.json();
            
            // åš´æ ¼åˆ¤æ–·ï¼šå¦‚æœ GAS å›å‚³ status ç‚º errorï¼Œè¦–ç‚ºå¯†ç¢¼éŒ¯èª¤
            if (data.status === "error") {
                alert("âŒ å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°å˜—è©¦ã€‚");
                sessionStorage.removeItem('sys_pwd');
                location.reload();
                return;
            }

            sessionStorage.setItem('sys_pwd', pwd);
            records = Array.isArray(data) ? data : [];
            
            quill = new Quill('#editor-container', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']
                    ]
                }
            });

            // åªæœ‰é©—è­‰æˆåŠŸæ‰é¡¯ç¤º body
            document.body.style.display = "block";
            updateUIByMode(); 
            render();
        } catch (e) {
            alert("âŒ é€£ç·šç•°å¸¸æˆ–å¯†ç¢¼éŒ¯èª¤ã€‚");
            sessionStorage.removeItem('sys_pwd');
            location.reload();
        }
    }

    function updateUIByMode() {
        document.getElementById('btnNew').style.display = mode === 'admin' ? 'inline-flex' : 'none';
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.toggle('active', b.dataset.mode === mode));
    }

    // ä¿®æ”¹ Bï¼šèª¿æ•´è‡ªå‹•é¡¯ç¤ºè‡³ 12/31 (ç²¾æº–è¨ˆç®—ä¸€å¹´æœŸå‰ä¸€å¤©)
    window.calcDefaultSchedule = () => {
        const startVal = document.getElementById('startDate').value;
        if (!startVal) return;
        
        // ä¿®æ­£è¿„æ—¥é‚è¼¯
        const startDate = new Date(startVal);
        const endDate = new Date(startVal);
        endDate.setFullYear(endDate.getFullYear() + 1); // åŠ ä¸€å¹´
        endDate.setDate(endDate.getDate() - 1);         // æ¸›ä¸€å¤©
        
        const yyyy = endDate.getFullYear();
        const mm = String(endDate.getMonth() + 1).padStart(2, '0');
        const dd = String(endDate.getDate()).padStart(2, '0');
        document.getElementById('endDate').value = `${yyyy}-${mm}-${dd}`;
        
        // è‡ªå‹•å¸¶å…¥æœˆä»½é‚è¼¯ (+2, +5, +8, +11)
        const parts = startVal.split('-');
        const y = parseInt(parts[0]), m = parseInt(parts[1]) - 1;
        editingYMList = [];
        [2, 5, 8, 11].forEach(offset => {
            const t = new Date(y, m + offset, 1);
            editingYMList.push(t.getFullYear() + '-' + String(t.getMonth() + 1).padStart(2, '0'));
        });
        renderYMChips();
    };

    function render() {
        const ym = document.getElementById('monthPick').value, q = document.getElementById('q').value.toLowerCase(), scope = document.getElementById('scope').value;
        const tbody = document.getElementById('rows');
        let filtered = records.filter(r => {
            const hasSch = (r.schedule || []).some(s => s.ym === ym);
            return (scope === 'need' ? hasSch : true) && (!q || r.customer.toLowerCase().includes(q) || (r.salesName || "").toLowerCase().includes(q));
        });
        filtered.sort((a, b) => a.customer.localeCompare(b.customer, 'zh-Hant'));
        tbody.innerHTML = '';
        filtered.forEach(r => {
            const sch = (r.schedule || []).find(s => s.ym === ym);
            const hasNotes = r.notes && r.notes.replace(/<(.|\n)*?>/g, '').trim().length > 0;

            tbody.insertAdjacentHTML('beforeend', `
                <tr>
                    <td class="col-customer">
                        <div class="cust-cell">
                            <span style="font-weight:700;">${esc(r.customer)}</span>
                            ${hasNotes ? `<span class="material-symbols-rounded note-trigger" onclick="viewNotes('${r.id}')" title="æŸ¥çœ‹å‚™è¨»">description</span>` : ''}
                        </div>
                    </td>
                    <td class="col-product"><div>${esc(r.product)}</div><span class="sales-tag">${esc(r.salesName)}</span></td>
                    <td class="col-period" style="font-size:0.85rem; color:var(--text-muted);">${esc(r.startDate)} ~ ${esc(r.endDate)}</td>
                    <td class="col-schedule">
                        <div class="month-group">${(r.schedule || []).map(s => `<span class="month-chip ${s.isDone ? 'is-done' : ''} ${s.ym === ym ? 'active' : ''}">${parseInt(s.ym.slice(5))}æœˆ</span>`).join('')}</div>
                    </td>
                    <td class="col-status" onclick="handleStatusClick('${r.id}', '${ym}')" style="cursor:pointer">
                        ${sch ? (sch.isDone ? `<span style="color:var(--success); font-weight:600">å·²å®Œå·¥</span>` : `<span style="color:var(--warning); font-weight:600">å¾…ç¶­è­·</span>`) : '--'}
                    </td>
                    <td class="col-action">
                        <div style="display:flex; gap:4px;">
                            ${sch ? `<button class="btn btn-outline" style="padding:4px;" onclick="handleStatusClick('${r.id}', '${ym}')"><span class="material-symbols-rounded" style="font-size:18px;">${sch.isDone ? 'history' : 'done'}</span></button>` : ''}
                            ${mode === 'admin' ? `<button class="btn btn-outline" style="padding:4px;" onclick="openEdit('${r.id}')"><span class="material-symbols-rounded" style="font-size:18px;">edit</span></button>` : ''}
                        </div>
                    </td>
                </tr>
            `);
        });
    }

    window.viewNotes = (id) => {
        const r = records.find(x => x.id === id);
        document.getElementById('noteDrawerTitle').textContent = r.customer + ' - å‚™è¨»ç´€éŒ„';
        document.getElementById('noteContent').innerHTML = r.notes;
        document.getElementById('noteDrawer').classList.add('open');
        document.getElementById('overlay').style.display = 'block';
    };

    window.openEdit = (id = null) => {
        editingId = id;
        const r = records.find(x => x.id === id) || { customer:"", product:"ee-class", salesName:"Willa", startDate:"", endDate:"", notes:"", schedule:[] };
        document.getElementById('drawerTitle').textContent = id ? "ç·¨è¼¯ç¶­è­·" : "æ–°å¢ç¶­è­·";
        document.getElementById('customer').value = r.customer;
        document.getElementById('product').value = r.product;
        document.getElementById('salesName').value = r.salesName;
        document.getElementById('startDate').value = r.startDate;
        document.getElementById('endDate').value = r.endDate;
        quill.root.innerHTML = r.notes || "";
        editingYMList = (r.schedule || []).map(s => s.ym).sort();
        renderYMChips();
        document.getElementById('editDrawer').classList.add('open');
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('btnDelete').style.display = id ? 'block' : 'none';
    };

    window.renderYMChips = () => {
        document.getElementById('ymList').innerHTML = editingYMList.map(ym => `<span class="editor-mchip">${ym} <span class="remove-btn" onclick="removeYM('${ym}')">Ã—</span></span>`).join('');
    };
    window.removeYM = (ym) => { editingYMList = editingYMList.filter(x => x !== ym); renderYMChips(); };
    window.addYM = () => {
        const v = document.getElementById('addYMInput').value;
        if(v && !editingYMList.includes(v)) { editingYMList.push(v); editingYMList.sort(); renderYMChips(); }
    };

    window.handleStatusClick = (id, ym) => {
        const r = records.find(x => x.id === id), sch = r.schedule.find(s => s.ym === ym);
        if(!sch) return;
        if(sch.isDone) {
            if(confirm("é‚„åŸç‚ºå¾…ç¶­è­·ï¼Ÿ")) { sch.isDone = false; saveAll(); }
        } else {
            modalTarget = { id, ym };
            document.getElementById('mDoneDate').value = new Date().toISOString().slice(0, 10);
            document.getElementById('doneModal').style.display = 'block';
        }
    };

    async function saveAll() {
        const pwd = sessionStorage.getItem('sys_pwd');
        await fetch(`${API_URL}&pwd=${encodeURIComponent(pwd)}`, { method: "POST", body: JSON.stringify(records) });
        render();
    }

    window.closeAllDrawers = () => { document.querySelectorAll('.drawer').forEach(d => d.classList.remove('open')); document.getElementById('overlay').style.display = 'none'; };
    window.closeModal = () => { document.getElementById('doneModal').style.display = 'none'; };

    document.getElementById('formEdit').onsubmit = async (e) => {
        e.preventDefault();
        const rData = {
            id: editingId || 'ID-' + Date.now(),
            customer: document.getElementById('customer').value,
            product: document.getElementById('product').value,
            salesName: document.getElementById('salesName').value,
            startDate: document.getElementById('startDate').value,
            endDate: document.getElementById('endDate').value,
            notes: quill.root.innerHTML,
            schedule: editingYMList.map(ym => {
                const old = (records.find(x => x.id === editingId)?.schedule || []).find(s => s.ym === ym);
                return old || { ym, isDone: false, engName: "" };
            })
        };
        if(!editingId) records.push(rData); else records[records.findIndex(x => x.id === editingId)] = rData;
        await saveAll(); closeAllDrawers();
    };

    document.getElementById('btnConfirmDone').onclick = async () => {
        const r = records.find(x => x.id === modalTarget.id);
        const sch = r.schedule.find(s => s.ym === modalTarget.ym);
        sch.isDone = true;
        sch.engName = document.getElementById('mEngName').value;
        sch.doneDate = document.getElementById('mDoneDate').value;
        await saveAll(); closeModal();
    };

    document.getElementById('modeSeg').onclick = (e) => {
        const b = e.target.closest('button'); if(!b) return;
        mode = b.dataset.mode; updateUIByMode(); render();
    };

    document.getElementById('btnDelete').onclick = async () => {
        if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç¶­è­·ï¼Ÿ")) { records = records.filter(x => x.id !== editingId); await saveAll(); closeAllDrawers(); }
    };

    document.getElementById('q').oninput = render;
    document.getElementById('monthPick').onchange = render;
    document.getElementById('scope').onchange = render;
    document.getElementById('btnNew').onclick = () => openEdit();
    load();
</script>
</body>
</html>
